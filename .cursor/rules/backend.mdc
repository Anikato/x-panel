---
name: backend
description: Go 后端开发规则 - Gin + GORM + SQLite 模式
globs: backend/**
---

# 后端开发规则

## 代码模式

### API Handler 模板
```go
func (api *XxxAPI) ActionName(c *gin.Context) {
    var req dto.XxxRequest
    if err := helper.CheckBindAndValidate(&req, c); err != nil {
        helper.ErrorWithDetail(c, http.StatusBadRequest, err.Error())
        return
    }
    // 调用 service，不在 handler 写业务逻辑
    result, err := xxxService.DoSomething(req)
    if err != nil {
        helper.ErrorWithDetail(c, http.StatusInternalServerError, err.Error())
        return
    }
    helper.SuccessWithData(c, result)
}
```

### Service 接口模板
```go
type IXxxService interface {
    Create(req dto.XxxCreate) error
    Page(req dto.XxxSearch) (int64, []dto.XxxDTO, error)
    Update(req dto.XxxUpdate) error
    Delete(req dto.BatchDelete) error
}

type XxxService struct{}

func NewIXxxService() IXxxService { return &XxxService{} }
```

### Model 模板
```go
type Xxx struct {
    model.BaseModel
    Name   string `gorm:"not null;uniqueIndex" json:"name"`
    Status string `gorm:"not null;default:'active'" json:"status"`
    // 关联用 foreignKey 标签
    Items []XxxItem `json:"items" gorm:"foreignKey:XxxID"`
}
```

### Repo 模板
```go
type XxxRepo struct{}

func NewIXxxRepo() IXxxRepo { return &XxxRepo{} }

func (r *XxxRepo) Page(page, pageSize int, opts ...repo.DBOption) (int64, []model.Xxx, error) {
    var count int64
    var items []model.Xxx
    db := global.DB
    for _, opt := range opts {
        db = opt(db)
    }
    db.Model(&model.Xxx{}).Count(&count)
    db.Limit(pageSize).Offset((page - 1) * pageSize).Find(&items)
    return count, items, nil
}
```

## 路由注册规则
- 公开路由（无需认证）：`/api/v1/auth/*`
- 私有路由（需 JWT）：`/api/v1/{module}/*`，挂载 `JWTAuth()` + `OperationLog()` 中间件
- WebSocket 路由：`/api/v1/ws/*`

## Nginx 操作规则
- Nginx 采用面板自包含安装，所有文件在 `{install_dir}/nginx/` 下
- 路径通过 `global.CONF.Nginx.GetXxx()` 方法获取，禁止硬编码
- 进程管理使用直接信号控制（`nginx -s reload/quit/stop`），不使用 systemctl
- 所有配置变更后必须 `nginx -t` → 失败回滚 → 成功 reload
- 使用 `utils/nginx/parser` 解析配置，`utils/nginx/dumper` 输出配置
- SSL 证书文件统一放 `{nginx_dir}/conf/ssl/{websiteAlias}/`

## 数据库规则
- 面板自身用 SQLite，通过 `global.DB` 访问
- 管理的 MySQL/PostgreSQL/Redis 通过独立连接，不走 `global.DB`
- 敏感字段（密码、私钥）存储时加密，读取时解密

## 错误处理
- Service 层返回 `buserr.New("ErrKey")` 业务错误
- Repo 层直接返回 GORM 原始错误
- API 层统一捕获并转换为 HTTP 响应
- 所有错误 key 在 `i18n/lang/` 中定义中英文翻译

## 命令执行
- 系统命令通过 `utils/cmd` 包装，带超时控制
- 禁止直接 `exec.Command` 拼接用户输入，防注入
- 长时间命令用 goroutine + context 控制
